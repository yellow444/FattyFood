function Upload(e,i){function s(i){if(!g){$("#"+e+"list > :not(."+e+"file)").remove();for(var s=0;s<i.length;s++){var l={},o=a(i[s]);1==o?(l.progress="<div><div></div></div>",l.id='<div id="'+e+"file_"+c+'" class="'+e+'file">'):(l.progress=o,l.id='<div class="'+e+"file "+e+'file_warning">');var l=l.id+'<div class="'+e+'file_body"><a class="'+e+'file_delete" href="javascript:;"></a><div class="'+e+'file_infos"><span class="'+e+'file_name">'+t(i[s].name)+'</span><span class="'+e+'file_size">('+n(i[s].size)+')</span></div><div class="'+e+'file_progress">'+l.progress+"</div></div></div>";$(l).appendTo("#"+e+"list"),1==o&&(u[c]=i[s],c++)}$("#"+e+"list").animate({scrollTop:$("#"+e+"list")[0].scrollHeight},1e3),u.length&&$("#"+e+"start").removeClass("disabled"),r()}}function a(e){var i=o();if(i.files==v.options.maxTotalFiles)return l("totalfiles");if(!e.name.match(/^.{1,250}\.(gif|jpe?g|png)$/i))return l("filename");if(-1==$.inArray(e.type,["image/gif","image/jpeg","image/png"]))return l("filetype");if(e.size>v.options.maxFilesize)return l("filesize");if(i.size+e.size>v.options.maxTotalSize)return l("totalsize");for(var s=0;s<u.length;s++)if(u[s]&&u[s].name==e.name)return l("sameFilename");return!0}function t(e){var i=v.options.maxFileNameLength;if(i&&(i-=9,e.length>i)){var s=new RegExp("^(.{"+i+"}).+(..{3,4})$");e=e.replace(s,"$1[...]$2")}return e}function n(e,i){var s=1024,a=1024*s;return i?(i="kb"==i?s:a,e=String(Math.round(e/i*100)/100)):e=a>e?v.options.l10n.sizeUnits[0].replace("%s",Math.round(e/s*100)/100):v.options.l10n.sizeUnits[1].replace("%s",Math.round(e/a*100)/100),e.replace(".",v.options.l10n.decimalPoint)}function l(i){return'<p class="'+e+'warning">'+v.options.l10n.warning[i]+"</p>"}function o(){for(var e=0,i=0,s=0;e<u.length;e++)u[e]&&(i++,s+=u[e].size);return{files:i,size:s}}function r(){if(!g){var i=o();$("#"+e+"infos_images").text(i.files+"/"+v.options.l10n.images.replace("%s",v.options.maxTotalFiles)),$("#"+e+"infos_filesize").text(n(i.size,"mb")+"/"+n(v.options.maxTotalSize)),i.files||$("#"+e+"start").addClass("disabled"),$("."+e+"file").length?$("#"+e+"clear").removeClass("disabled"):$("#"+e+"clear").addClass("disabled")}}function d(){var i=u[c],s=0,a=function(){c++,d()};if(!i)return void(i===!1?a():m?$("#"+e+"form").submit():(g=!1,$("#"+e+"add,#"+e+"start").removeClass("disabled")));var t=new FileReader;t.readAsDataURL(i),t.onerror=function(e){console.log("File could not be read ("+e.target.error.code+")")},t.onload=function(t){v.options.ajaxData.filename=encodeURI(i.name),v.options.ajaxData.filedata=t.target.result.split(",")[1],$.ajax({type:"POST",url:v.options.ajaxScript,data:v.options.ajaxData,dataType:"json",xhr:function(){var a=new XMLHttpRequest;return a.upload.onprogress=function(a){if(a.lengthComputable){var t=Math.round(100*a.loaded/a.total);$("#"+e+"file_"+c+" ."+e+"file_progress div div").css({width:t+"%"});var n=a.loaded/a.total*i.size;f.loadedSize+=n-s,$("#"+e+"infos_progress_pc").text(Math.round(100*f.loadedSize/f.size)+"%"),s=n}},a},complete:function(i){if("object"==typeof i.responseJSON){var s=i.responseJSON.message;""!=s&&(s=" : "+encodeURI(s)),$("#"+e+"list").after('<input name="'+i.responseJSON.status+'[]" type="hidden" value="'+encodeURI(i.responseJSON.filename)+s+'" />')}a()},error:function(i){$("#"+e+"file_"+c).addClass(e+"file_error"),$("#"+e+"file_"+c+" ."+e+"file_progress").html('<p class="'+e+'error">'+v.options.l10n.failed+"</p>"),console.log(i.responseText)},success:function(){var i=c;$("#"+e+"file_"+c).addClass(e+"file_success"),$("#"+e+"file_"+c+" ."+e+"file_progress").html('<p class="'+e+'error">'+v.options.l10n.success+"</p>"),setTimeout(function(){$("#"+e+"file_"+i+" ."+e+"file_delete").click()},2e3),m=!0}})}}this.options;var f,c=0,p=$("#"+e+"list").html(),u=[],m=!1,g=!1,v=this;v.options=i,1==$("#"+e+"add").length&&($("#"+e+"input_file").hide().on("change",function(e){s(this.files)}),$(document).on("click","#"+e+"add",function(){return g||$("#"+e+"input_file").click(),!1})),1==$("#"+e+"clear").length&&$(document).on("click","#"+e+"clear",function(){return $(this).hasClass("disabled")?!1:($(this).addClass("disabled"),c=0,u=[],$("."+e+"file").remove(),$(p).appendTo("#"+e+"list"),r(),!1)}),1==$("#"+e+"start").length&&$(document).on("click","#"+e+"start",function(){return $(this).hasClass("disabled")||g||!u.length?!1:v.options.ajaxData.id?(g=!0,$("#"+e+"add,#"+e+"start").addClass("disabled"),$("#"+e+"list").animate({scrollTop:0},250,"swing",function(){setTimeout(function(){c=0,f=o(),f.loadedFiles=0,f.loadedSize=0,d()},250)}),!1):(alert(v.options.l10n.noAlbum),!1)}),$(document).on("click","."+e+"file_delete",function(){if(!$(this).parents("."+e+"file").hasClass(e+"file_warning")){var i=$(this).parents("."+e+"file").attr("id").replace(e+"file_","");u[i]=!1}$(this).parents("."+e+"file").animate({opacity:0,height:0},{duration:300,easing:"swing",complete:function(){$(this).remove(),g||0!=$("."+e+"file").length||$(p).appendTo("#"+e+"list"),r()}})}),$(document).on("dragover","#"+e+"list",function(){return g||$(this).removeClass().addClass("dragover"),!1}),$(document).on("dragleave","#"+e+"list",function(){return g||$(this).removeClass().addClass("dragleave"),!1}),$(document).on("drop","#"+e+"list",function(e){return!g&&e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length?($(this).removeClass().addClass("drop"),s(e.originalEvent.dataTransfer.files)):$(this).removeClass(),!1}),r()}